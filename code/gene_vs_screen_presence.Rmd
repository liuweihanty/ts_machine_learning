---
title: "gene_vs_screen_presence"
author: "Weihan Liu"
date: "18/05/2020"
output: html_document
---

Plot all 96 genes from Jeremy's datamining efforts vs all the screens he used.

Goal:
1).visualzie the genes that are identified to be putative TS by the most screens
2).Determine which screen contributes the most to datamining

```{r}
library(pheatmap)
```

```{r}
gene_vs_screen <- read.csv("/Users/weihan/Documents/GitHub/ts_machine_learning/data/summary_analysis/gene_vs_screen_presence.csv",stringsAsFactors = FALSE) %>%
        dplyr::select(-c("X")) %>%
        dplyr::rename(apperance = X..of.screens) %>%
        arrange(desc(apperance))
        
#replace all "Yes" with 1 and all other cells with 0
gene_vs_screen[,2:14] <- ifelse(gene_vs_screen[,2:14] == "Yes",1,0)
gene_vs_screen <- column_to_rownames(gene_vs_screen,var = "Gene")     

str(gene_vs_screen)

#Examine which screen has the highest number of genes 
as.data.frame(colSums(gene_vs_screen)) %>%
                                                rownames_to_column(var = "screen") %>%
                                                arrange(desc(colSums(gene_vs_screen)))
#order the columns in the dataframe by their colsums, descending order.(for plottig)
gene_vs_screen <- gene_vs_screen[,c("Weissman.2016","Elledge.2018",
                  "Wallace.2016","Doench.2018",
                  "Sabatini.2015.GTS","Elledge.2013",
                  "GCG",
                  "Sabatini.2015","Weissman.2014",
                  "Campbell.2018","Sabatini.2017",
                  "Chen.2019","Brummelkamp.2015","apperance")]
```

Plot heatmap
```{r,fig.height=18,fig.width=15}
pheatmap(as.matrix(gene_vs_screen[1:13]),
        scale = "none",
        cexRow = 0.3,cexCol = 3,
        cellwidth = 50,
        cellheight = 11,
         color = c("#d7ebff","#ffd452"),
         #color = c("#ffe4d8","#ff5e4f"), deep and shallow red  
        # color = c("#EBF6FF","#64aaff"),  #deep and shallow blue                
        #border_color = "black",
        cluster_cols = FALSE,
        cluster_rows = FALSE,
        treeheight_col = 0, #get rid of the dendrogram
        legend_breaks = c(0,1),
        legend_labels = c("absent in screen","present in screen"),
        fontsize_col = 20,
        angle_col = 45)


```



Grand Heatmap:

1).continuous variables:
Proliferation score, 
Erythroid differentiation impairment score
Combined experimental score
z scores on all CRISPR screens we used
Machine Learning score

2.).categorical variables
Cancer Gene Census TS status
CDR status

read in all the predictor columns
```{r}
rf_predictors <- read.csv("/Users/weihan/Documents/GitHub/ts_machine_learning/data/gwide_hema_classification/gwide_dup_rm_knn_CGC.csv",stringsAsFactors = FALSE)
#only retain the crispr score and gene name columns
rf_predictors <- select(rf_predictors,-c("chromosome","TS_status"))
```

Read in

classification machine learning score
```{r}
rf_class_result <- read.csv("/Users/weihan/Documents/GitHub/ts_machine_learning/data/gwide_hema_classification/pred_hits_CGC_bootstrap.csv",stringsAsFactors = FALSE)
rf_class_result <-  dplyr::select(rf_class_result,-"X") 

```


Proliferation score, 
Erythroid differentiation impairment score
Combined experimental score
```{r}
exp_score <- read.csv("/Users/weihan/Documents/GitHub/ts_machine_learning/data/z_value_calc/comb_ranking.csv",stringsAsFactors = FALSE)
exp_score <- select(exp_score,c("Gene","avg.pro","avg.ery","avg_comb"))
str(exp_score)
```

CGC status
```{r}
CGC_status <- read.csv("/Users/weihan/Documents/GitHub/ts_machine_learning/data/gwide_hema_classification/GCG_TS.csv",stringsAsFactors = FALSE)
CGC_status <- select(CGC_status,"Gene.Symbol") %>% 
        rename(Gene = Gene.Symbol) %>% mutate(CGC_TS = 1)
```

CDR status
```{r}
CDR_status <- read.csv("/Users/weihan/Documents/GitHub/ts_machine_learning/data/CDR_list.csv",stringsAsFactors = FALSE,header = FALSE)
names(CDR_status) <- "Gene"
CDR_status <- mutate(CDR_status,CDR_status = 1)
```
Combine everything together, note we will only plot the genes used in experiment
```{r}
grand_sheet <- left_join(exp_score,rf_predictors,by = "Gene") %>% 
        left_join(rf_class_result, by = "Gene") %>%
        left_join(CGC_status, by = "Gene") %>%
        left_join(CDR_status, by = "Gene")
#convert the NAs in CGC status and CDR status to 0
grand_sheet$CGC_TS[is.na(grand_sheet$CGC_TS)] <- 0
grand_sheet$CDR_status[is.na(grand_sheet$CDR_status)] <- 0

#relocate columns to leave all the crispr screen data to the ;later half
grand_sheet <- grand_sheet %>% 
        relocate(TS_freq,.after = Gene) %>% relocate(c("CGC_TS","CDR_status"),.before = TS_freq)
str(grand_sheet)
```

Impute missing values
```{r}
# test which column has missing values
apply(grand_sheet,2,is.na) %>% apply(2,sum)

#change all the missing values in TS_freq to 100, which means not tumor suppressor
grand_sheet$TS_freq[is.na(grand_sheet$TS_freq)] <- 100

#change all the missing values in the crispr screen columns to 0
grand_sheet[is.na(grand_sheet)] <- 0

#make a duplivate copy for calculating z scores
grand_sheet_z <- grand_sheet
```

Calculate z scores
```{r}
z_score <- function(x){
        (x - mean(x))/sd(x)
}
grand_sheet_z[4:ncol(grand_sheet_z)] <- apply(grand_sheet_z[4:ncol(grand_sheet_z)],2,z_score)
str(grand_sheet_z)
```

Plot heatmap
```{r,fig.width=7,fig.height=7}
library(heatmap3)
#subset out the continuous columns of the grand sheet
grand_sheet_z_cont <- select(grand_sheet_z,-c("CGC_TS","CDR_status")) %>%
        column_to_rownames(var = "Gene")

grand_sheet_z_cont <- grand_sheet_z_cont[order(grand_sheet_z_cont$avg_comb),]
heatmap3(as.matrix(grand_sheet_z_cont),Colv = NA,Rowv = NA,margin=c(7,7),
        balanceColor = TRUE,
        cexRow = 0.4
)

```

